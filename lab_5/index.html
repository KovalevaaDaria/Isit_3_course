<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VK API Lab ‚Ä¢ –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #404040;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .page-header {
            color: #e0e0e0;
            text-align: center;
            margin: 1rem 0;
            font-size: 2em;
            font-weight: 500;
            letter-spacing: normal;
            padding-bottom: 1rem;
            font-family: inherit;
        }

        .task-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .input-dark {
            background: #333 !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
            text-align: left !important;
        }

        .result-box {
            background: #252525;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .user-item {
            margin: 8px 0;
            padding: 10px;
            background: #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .id-badge {
            background: #404040;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
            color: #aaa;
        }

        .btn {
            padding: 0.3rem 0.75rem;
            font-size: 0.9em;
            margin-top: 0.5rem;
            max-width: 250px;
        }

        #authButton {
            padding: 0.3rem 0.75rem;
            font-size: 1em;
        }

        .participant-block {
            margin-bottom: 1rem;
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
        }

        .participant-header {
            padding: 1rem;
            background: #404040;
            cursor: pointer;
            list-style: none;
        }

        .participant-content {
            padding: 1rem;
        }

        details[open] .toggle-icon {
            transform: rotate(180deg);
        }

        .result-box {
            background: #252525;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ */
        }

        .task-card.auth-section {
            margin-bottom: 2.5rem !important; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
        }

        .task-header {
            cursor: pointer;
            padding: 1rem;
            background: #353535;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s ease;
        }

        .task-header:hover {
            background: #404040;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
            font-size: 0.9em;
            color: #888;
        }

        .collapsed .collapse-icon {
            transform: rotate(180deg);
        }

        /* –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #404040;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .page-header {
            color: #e0e0e0;
            text-align: center;
            margin: 1rem 0;
            font-size: 2em;
            font-weight: 500;
            letter-spacing: normal;
            padding-bottom: 1rem;
            font-family: inherit;
        }

        /* –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
        .id-badge.small {
            padding: 2px 6px;
            font-size: 0.8em;
            background: #404040;
        }

        .participant-header.bg-success {
            background: #2d7a4d !important;
        }

        .highlight {
            background: rgba(45, 122, 77, 0.1);
            border-left: 3px solid #2d7a4d;
        }

        .highlight .participant-header {
            background: #2d7a4d !important;
        }

        .user-item .link-success {
            color: #8f9bb3;
            text-decoration: none;
            font-size: 0.9em;
        }

        .user-item .link-success:hover {
            color: #5d6c89;
        }

        .text-muted.small {
            font-size: 0.85em;
            color: #888 !important;
        }

        .highlight .participant-header {
            background: #2d7a4d !important;
            color: white;
        }

        .highlight {
            border-left: 3px solid #2d7a4d;
            background: rgba(45, 122, 77, 0.1);
        }

        .bg-success {
            background: #2d7a4d !important;
        }

        .input-dark.is-invalid {
            border-color: #dc3545 !important;
            background: #3d1a1d !important;
        }

        .input-dark.is-invalid::placeholder {
            color: #dc3545 !important;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.8em;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-header">VK API Lab</h1>
        <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div class="task-card card auth-section">
            <div class="card-body">
                <h5 class="card-title mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Client ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
                        <input type="text" class="form-control input-dark" 
                               id="clientId" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Client ID">
                    </div>
                    
                    <div class="col-12">
                        <button class="btn btn-primary w-100" 
                                id="authButton">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ VK</button>
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label">–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞</label>
                        <input type="text" class="form-control input-dark" 
                               id="manualToken" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é">
                    </div>
                    
                    <div class="col-12">
                        <button class="btn btn-outline-primary w-100" 
                                id="saveTokenBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
                    </div>
                    
                    <div class="col-12">
                        <div class="result-box mt-2">
                            –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω: <span id="tokenDisplay">–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 1 -->
        <div class="task-card card">
            <div class="card-body">
                <h5 class="card-title mb-4">–î—Ä—É–∑—å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã</h5>
                
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                    <input type="input" class="form-control input-dark" 
                           id="task1-limit" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Ö –¥—Ä—É–∑–µ–π">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ID –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" class="form-control input-dark" 
                           id="task1-group" placeholder="–í–≤–µ–¥–∏—Ç–µ id –≥—Ä—É–ø–ø—ã –∏–ª–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞">
                </div>
                
                <button class="btn btn-primary w-100" onclick="task1()">–°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <div id="task1-result" class="result-box mt-3"></div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 2 -->
        <div class="task-card card">
            <div class="card-body">
                <h5 class="card-title mb-4">–õ–∞–π–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–º –æ–Ω–ª–∞–π–Ω</h5>
                
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π</label>
                    <input type="text" class="form-control input-dark" 
                           id="task2-limit" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π, –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ">
                </div>
                
                <button class="btn btn-primary w-100" onclick="task2()">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏</button>
                <div id="task2-result" class="result-box mt-3"></div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 3 -->
        <div class="task-card card">
            <div class="card-body">
                <h5 class="card-title mb-4">–ü–æ—Å—Ç –æ –≥—Ä—É–ø–ø–∞—Ö</h5>
                <button class="btn btn-primary w-100" onclick="task3()">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
                <div id="task3-result" class="result-box mt-3"></div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 4 -->
        <div class="task-card card">
            <div class="card-body">
                <h5 class="card-title mb-4">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π</h5>
                
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π</label>
                    <input type="input" class="form-control input-dark" 
                           id="task4-limit" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π —Å –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫">
                </div>
                
                <button class="btn btn-primary w-100" onclick="task4()">–ù–∞–π—Ç–∏</button>
                <div id="task4-result" class="result-box mt-3"></div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 5 -->
        <div class="task-card card">
            <div class="card-body">
                <h5 class="card-title mb-4">–ê–≤—Ç–æ—Ä—ã –Ω–æ–≤–æ—Å—Ç–µ–π</h5>
                <button class="btn btn-primary w-100" onclick="task5()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                <div id="task5-result" class="result-box mt-3"></div>
            </div>
        </div>
    </div>

    <script>

        let accessToken = null;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è—è
        document.getElementById('authButton').addEventListener('click', function() {
            const clientId = document.getElementById('clientId').value.trim();
            const redirectUri = 'https://oauth.vk.com/blank.html';
            
            if(!clientId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ Client ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!', 'danger');
                return;
            }

            const authUrl = 
                `https://oauth.vk.com/authorize?` +
                `client_id=${clientId}&` +
                `display=page&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=token&` +
                `scope=friends,groups,wall,offline&` +
                `v=5.131`;

            const authWindow = window.open(authUrl, 'vk_auth', 'width=600,height=700');

            const checkAuth = setInterval(() => {
                try {
                    if(authWindow.closed) {
                        clearInterval(checkAuth);
                        return;
                    }

                    const hash = new URL(authWindow.location.href).hash.slice(1);
                    const params = new URLSearchParams(hash);

                    if(params.has('access_token')) {
                        clearInterval(checkAuth);
                        accessToken = params.get('access_token');
                        authWindow.close();
                        
                        localStorage.setItem('vkLabToken', accessToken);
                        updateTokenDisplay();
                        showNotification('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                    }
                } catch(e) {}
            }, 100);
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('saveTokenBtn').addEventListener('click', () => {
            const token = document.getElementById('manualToken').value.trim();
            if(token) {
                accessToken = token;
                localStorage.setItem('vkLabToken', token);
                updateTokenDisplay();
                showNotification('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
            }
        });

        function updateTokenDisplay() {
            const display = document.getElementById('tokenDisplay');
            if(accessToken) {
                display.textContent = `–¢–æ–∫–µ–Ω: ${accessToken.slice(0, 15)}...`;
                document.getElementById('manualToken').value = accessToken;
            } else {
                display.textContent = '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            }
        }

        // –ò–Ω–∏—Ü–∏–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('vkLabToken');
            const hashParams = new URLSearchParams(window.location.hash.slice(1));
            
            if(hashParams.has('access_token')) {
                accessToken = hashParams.get('access_token');
                localStorage.setItem('vkLabToken', accessToken);
                window.history.replaceState({}, '', window.location.pathname);
            } else if(savedToken) {
                accessToken = savedToken;
            }
            
            updateTokenDisplay();
        });

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(text, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} notification`;
            alert.innerHTML = text; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –≤–º–µ—Å—Ç–æ textContent
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        function vkRequest(method, params = {}) {
            return new Promise((resolve, reject) => {
                if(!accessToken) {
                    showNotification('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!', 'danger');
                    return reject('No access token');
                }

                const callbackName = `jsonp_${Math.random().toString(36).substr(2, 9)}`;
                const url = new URL(`https://api.vk.com/method/${method}`);
                
                url.searchParams.set('access_token', accessToken);
                url.searchParams.set('v', '5.131');
                for(const [key, value] of Object.entries(params)) {
                    url.searchParams.set(key, value);
                }

                window[callbackName] = function(response) {
                    delete window[callbackName];
                    if(response.error) {
                        handleVkError(response.error);
                        return reject(response.error);
                    }
                    resolve(response.response);
                };

                const script = document.createElement('script');
                script.src = `${url}&callback=${callbackName}`;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }

        function handleVkError(error) {
            const errors = {
                5: '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏',
                6: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤',
                100: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä',
                113: '–ù–µ–≤–µ—Ä–Ω—ã–π ID',
                214: '–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞'
            };
            
            const message = errors[error.error_code] || error.error_msg;
            showNotification(`–û—à–∏–±–∫–∞: ${message}`, 'danger');
        }


        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        function validateFields(rules) {
            let errors = [];
            
            rules.forEach(rule => {
                const input = document.querySelector(rule.selector);
                const value = input.value.trim();
                input.classList.remove('is-invalid');

                if (rule.required && !value) {
                    input.classList.add('is-invalid');
                    errors.push(rule.messages.required);
                    return;
                }
                
                if (rule.number && (isNaN(value) || Number(value) <= 0)) {
                    input.classList.add('is-invalid');
                    errors.push(rule.messages.number);
                }
            });
            
            return [...new Set(errors)]; // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        }

        function validateNumberFields(fields) {
            let errors = [];
            fields.forEach(({selector, message}) => {
                const input = document.querySelector(selector);
                const value = input.value.trim();
                if (isNaN(value) || Number(value) <= 0) {
                    input.classList.add('is-invalid');
                    errors.push(message);
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            return errors;
        }

    
        // –ó–∞–¥–∞–Ω–∏–µ 1
        function task1() {
            const resultBox = document.getElementById('task1-result');
            const startTime = Date.now();
            resultBox.innerHTML = '';
            resultBox.style.display = 'block';

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π
            const errors = validateFields([
                {
                    selector: '#task1-group',
                    required: true,
                    messages: { required: '–£–∫–∞–∂–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã' }
                },
                {
                    selector: '#task1-limit',
                    required: true,
                    number: true,
                    messages: {
                        required: '–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤',
                        number: '–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0'
                    }
                }
            ]);

            if (errors.length > 0) {
                showNotification(errors.join('<br>'), 'danger');
                return;
            }

            const limit = document.getElementById('task1-limit').value;
            const groupId = document.getElementById('task1-group').value;

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            const vkRequestWithRetry = (method, params, retries = 3) => {
                return new Promise((resolve, reject) => {
                    const attempt = (retryCount) => {
                        vkRequest(method, params)
                            .then(resolve)
                            .catch(error => {
                                if (error.error_code === 6 && retryCount > 0) {
                                    setTimeout(() => attempt(retryCount - 1), 1000 * (4 - retryCount));
                                } else {
                                    reject(error);
                                }
                            });
                    };
                    attempt(retries);
                });
            };

            // –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
            vkRequestWithRetry('groups.getMembers', {
                group_id: groupId,
                count: limit,
                fields: 'first_name,last_name,deactivated,is_closed,can_access_closed'
            })
            .then(membersResponse => {
                const members = membersResponse.items;
                resultBox.innerHTML = `<div class="text-muted">–ù–∞–π–¥–µ–Ω–æ ${members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...</div>`;

                return members.reduce((chain, member, index) => {
                    return chain.then(() => {
                        return new Promise(resolve => {
                            setTimeout(() => {
                                // –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                const userHeader = `
                                    <details class="participant-block">
                                        <summary class="participant-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-secondary me-2">#${index + 1}</span>
                                                    ${member.first_name} ${member.last_name}
                                                    <small class="text-muted">(ID: ${member.id})</small>
                                                </div>
                                                <span class="toggle-icon">‚ñº</span>
                                            </div>
                                        </summary>
                                        <div class="participant-content">
                                `;

                                let contentPromise;
                                
                                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                if (member.deactivated) {
                                    contentPromise = Promise.resolve('<div class="text-warning">–ü—Ä–æ—Ñ–∏–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</div>');
                                } else if (member.is_closed && !member.can_access_closed) {
                                    contentPromise = Promise.resolve('<div class="text-warning">–ó–∞–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>');
                                } else {
                                    // –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥—Ä—É–∑—å—è—Ö
                                    contentPromise = vkRequestWithRetry('friends.get', {
                                        user_id: member.id,
                                        count: 0
                                    }, 2)
                                    .then(friends => {
                                        let content = `<div class="mb-2">–í—Å–µ–≥–æ –¥—Ä—É–∑–µ–π: ${friends.count}</div>`;
                                        
                                        if (friends.count > 0) {
                                            return vkRequestWithRetry('friends.get', {
                                                user_id: member.id,
                                                count: 20,
                                                fields: 'first_name,last_name'
                                            }, 2)
                                            .then(friendsList => {
                                                content += friendsList.items.map(f => `
                                                    <div class="user-item">
                                                        <div class="id-badge">${f.id}</div>
                                                        ${f.first_name} ${f.last_name}
                                                    </div>
                                                `).join('');
                                                return content;
                                            });
                                        }
                                        return content + '<div class="text-muted">–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                                    })
                                    .catch(error => {
                                        return `<div class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π: ${error.error_msg}</div>`;
                                    });
                                }

                                // –í—Å—Ç–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                                contentPromise
                                    .then(content => {
                                        const userBlock = `
                                            ${userHeader}
                                            ${content}
                                            </div>
                                            </details>
                                        `;
                                        
                                        resultBox.insertAdjacentHTML('beforeend', userBlock);
                                        resolve();
                                    })
                                    .catch(error => {
                                        const errorBlock = `
                                            ${userHeader}
                                            <div class="text-danger">–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${error.message}</div>
                                            </div>
                                            </details>
                                        `;
                                        resultBox.insertAdjacentHTML('beforeend', errorBlock);
                                        resolve();
                                    });
                            }, 350 * (index + 1)); // –£–≤–µ–ª–∏—á–∏–≤–∞—é—â–∞—è—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞
                        });
                    });
                }, Promise.resolve());
            })
            .then(() => {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
                resultBox.insertAdjacentHTML('beforeend', `
                    <div class="text-muted mt-3 small">
                        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${totalTime} —Å–µ–∫
                    </div>
                `);
            })
            .catch(error => {
                resultBox.innerHTML = `
                    <div class="text-danger">
                        –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.error_msg || error.message}
                    </div>
                `;
            });
        }


        // –ó–∞–¥–∞–Ω–∏–µ 2
        function task2() {
        const resultBox = document.getElementById('task2-result');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        const errors = validateFields([
            {
                selector: '#task2-limit',
                required: true,
                number: true,
                messages: {
                    required: '–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π',
                    number: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0'
                }
            }
        ]);

        if (errors.length > 0) {
            resultBox.style.display = 'none';
            showNotification(errors.join('<br>'), 'danger');
            return;
        }

        const limit = parseInt(document.getElementById('task2-limit').value) || 5;
        resultBox.style.display = 'block';
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏–∑ –∑–∞–¥–∞–Ω–∏—è 1
        function vkRequestWithRetry(method, params, retries = 3) {
            return new Promise((resolve, reject) => {
                const attempt = (retryCount) => {
                    vkRequest(method, params)
                        .then(resolve)
                        .catch(error => {
                            if (error.error_code === 6 && retryCount > 0) {
                                setTimeout(() => attempt(retryCount - 1), 1000 * (4 - retryCount));
                            } else {
                                reject(error);
                            }
                        });
                };
                attempt(retries);
            });
        }

        resultBox.innerHTML = '<div class="text-muted">–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π...</div>';
        
        vkRequestWithRetry('friends.get', {
            fields: 'last_seen,can_see_all_posts',
            count: 1000
        })
        .then(friends => {
            const sortedFriends = friends.items
                .filter(f => f.last_seen && f.can_see_all_posts)
                .sort((a, b) => b.last_seen.time - a.last_seen.time)
                .slice(0, limit);

            resultBox.innerHTML = '<div class="text-muted">–°—Ç–∞–≤–∏–º –ª–∞–π–∫–∏...</div>';
            let successCount = 0;
            const resultList = [];

            return sortedFriends.reduce((chain, friend) => {
                return chain.then(() => {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            vkRequestWithRetry('wall.get', {
                                owner_id: friend.id,
                                count: 1,
                                filter: 'owner'
                            }, 2)
                            .then(posts => {
                                if (posts.items.length > 0) {
                                    return vkRequestWithRetry('likes.add', {
                                        type: 'post',
                                        owner_id: friend.id,
                                        item_id: posts.items[0].id
                                    }, 2)
                                    .then(() => {
                                        resultList.push(`
                                            <div class="user-item">
                                                <div class="id-badge">ID: ${friend.id}</div>
                                                <div class="user-info">
                                                    ${friend.first_name} ${friend.last_name}
                                                    <span class="text-success">‚úì –õ–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω</span>
                                                </div>
                                            </div>
                                        `);
                                        successCount++;
                                    });
                                } else {
                                    resultList.push(`
                                        <div class="user-item">
                                            <div class="id-badge">ID: ${friend.id}</div>
                                            <div class="user-info text-warning">
                                                ${friend.first_name} ${friend.last_name}
                                                <span class="text-warning">‚Ä¢ –ù–µ—Ç –ø–æ—Å—Ç–æ–≤</span>
                                            </div>
                                        </div>
                                    `);
                                }
                            })
                            .catch(error => {
                                resultList.push(`
                                    <div class="user-item">
                                        <div class="id-badge">ID: ${friend.id}</div>
                                        <div class="user-info text-danger">
                                            ${friend.first_name} ${friend.last_name}
                                            <span class="text-danger">‚Ä¢ –û—à–∏–±–∫–∞: ${error.error_msg || '–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞'}</span>
                                        </div>
                                    </div>
                                `);
                            })
                            .finally(() => {
                                resultBox.innerHTML = `
                                    <div class="text-muted">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${resultList.length}/${sortedFriends.length}</div>
                                    <div class="user-list">${resultList.join('')}</div>
                                `;
                                resolve();
                            });
                        }, 350); // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    });
                });
            }, Promise.resolve())
            .then(() => ({ successCount, resultList }));
        })
        .then(({ successCount, resultList }) => {
            resultBox.innerHTML = `
                <div class="text-success mb-2">–ó–∞–ø—Ä–æ—à–µ–Ω–æ: ${limit}</div>
                <div class="text-success mb-2">–£—Å–ø–µ—à–Ω–æ: ${successCount} –ª–∞–π–∫–æ–≤</div>
                <div class="user-list">${resultList.join('')}</div>
            `;
        })
        .catch(error => {
            const errorMsg = error.error_code === 6 
                ? '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ' 
                : error.error_msg || error.message;
                
            resultBox.innerHTML = `
                <div class="text-danger">
                    –û—à–∏–±–∫–∞: ${errorMsg}
                </div>
            `;
        });
    }


        // –ó–∞–¥–∞–Ω–∏–µ 3
        function task3() {
        const resultBox = document.getElementById('task3-result');
        resultBox.style.display = 'block';
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π
        function vkRequestWithRetry(method, params, retries = 3) {
            return new Promise((resolve, reject) => {
                const attempt = (retryCount) => {
                    vkRequest(method, params)
                        .then(resolve)
                        .catch(error => {
                            if (error.error_code === 6 && retryCount > 0) {
                                setTimeout(() => attempt(retryCount - 1), 1000 * (4 - retryCount));
                            } else {
                                reject(error);
                            }
                        });
                };
                attempt(retries);
            });
        }

        resultBox.innerHTML = '<div class="text-muted">–ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–∞—Ö...</div>';

        vkRequestWithRetry('groups.get', {
            extended: 1,
            fields: 'name,members_count',
            count: 5
        })
        .then(groups => {
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
            const postText = groups.items.map(group => 
                `üîπ ${group.name} (${group.members_count || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)`
            ).join('\n');

            // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç
            return vkRequestWithRetry('wall.post', {
                message: `–ú–æ–∏ –≥—Ä—É–ø–ø—ã:\n${postText}`
            })
            .then(postResult => ({ groups, postResult }));
        })
        .then(({ groups, postResult }) => {
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const groupsHTML = groups.items.map(group => `
                <div class="user-item">
                    <div class="id-badge">ID: -${group.id}</div>
                    <div class="user-info">
                        ${group.name}<br>
                        <small>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${group.members_count || 0}</small>
                    </div>
                </div>
            `).join('');

            resultBox.innerHTML = `
                <div class="text-success mb-2">–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω! ID: ${postResult.post_id}</div>
                <div class="user-list">${groupsHTML}</div>
            `;
        })
        .catch(error => {
            const errorMsg = error.error_code === 6 
                ? '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ' 
                : error.error_msg || error.message;
                
            resultBox.innerHTML = `
                <div class="text-danger">
                    –û—à–∏–±–∫–∞: ${errorMsg}
                </div>
            `;
        });
    }


        // –ó–∞–¥–∞–Ω–∏–µ 4
        function task4() {
        const resultBox = document.getElementById('task4-result');
        const startTime = Date.now();
        resultBox.style.display = 'block';
        
        const errors = validateFields([{
            selector: '#task4-limit',
            required: true,
            number: true,
            messages: {
                required: '–£–∫–∞–∂–∏—Ç–µ –ª–∏–º–∏—Ç –ø–æ–∏—Å–∫–∞',
                number: '–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0'
            }
        }]);

        if (errors.length > 0) {
            showNotification(errors[0], 'danger');
            return;
        }

        const limit = Number(document.getElementById('task4-limit').value);
        resultBox.innerHTML = '<div class="text-muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞...</div>';

        let myId;
        let candidates = [];
        let friendSources = new Map();

        function vkRequestWithRetry(method, params, retries = 3) {
            return new Promise((resolve, reject) => {
                const attempt = (retryCount) => {
                    vkRequest(method, params)
                        .then(resolve)
                        .catch(error => {
                            if (error.error_code === 6 && retryCount > 0) {
                                setTimeout(() => attempt(retryCount - 1), 1000 * (4 - retryCount));
                            } else {
                                reject(error);
                            }
                        });
                };
                attempt(retries);
            });
        }

        vkRequestWithRetry('users.get', {})
        .then(me => {
            myId = me[0].id;
            return vkRequestWithRetry('friends.get', {
                count: limit,
                fields: 'first_name,last_name,domain,is_closed,deactivated'
            });
        })
        .then(myFriends => {
            if (!myFriends.items?.length) {
                resultBox.innerHTML = '<div class="text-warning">–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>';
                return Promise.reject();
            }

            return myFriends.items.reduce((chain, friend, index) => {
                return chain.then(() => new Promise(resolve => {
                    if (friend.deactivated || friend.is_closed) {
                        resolve();
                        return;
                    }

                    setTimeout(() => {
                        vkRequestWithRetry('friends.get', {
                            user_id: friend.id,
                            fields: 'counters,is_closed,deactivated',
                            count: 1000
                        }, 2)
                        .then(response => {
                            response.items.forEach(fof => {
                                if (fof.id === myId || fof.is_closed || fof.deactivated) return;
                                
                                const existIndex = candidates.findIndex(c => c.id === fof.id);
                                const friendsCount = fof.counters?.friends || 0;
                                
                                if (existIndex > -1) {
                                    if (friendsCount > candidates[existIndex].count) {
                                        candidates[existIndex].count = friendsCount;
                                        friendSources.set(fof.id, {
                                            throughFriend: friend,
                                            updatedAt: Date.now()
                                        });
                                    }
                                } else {
                                    candidates.push({
                                        id: fof.id,
                                        count: friendsCount,
                                        firstName: fof.first_name,
                                        lastName: fof.last_name
                                    });
                                    friendSources.set(fof.id, {
                                        throughFriend: friend,
                                        updatedAt: Date.now()
                                    });
                                }
                            });

                            resultBox.innerHTML = `
                                <div class="text-muted">
                                    –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${index + 1}/${myFriends.items.length}<br>
                                    –ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: ${candidates.length}<br>
                                    –í—Ä–µ–º—è: ${((Date.now() - startTime)/1000).toFixed(1)} —Å–µ–∫
                                </div>
                            `;
                            resolve();
                        })
                        .catch(() => resolve());
                    }, 350);
                }));
            }, Promise.resolve());
        })
        .then(() => {
            if (candidates.length === 0) {
                resultBox.innerHTML = '<div class="text-warning">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>';
                return;
            }

            const maxEntry = candidates.reduce((max, current) => 
                current.count > max.count ? current : max, candidates[0]);

            return vkRequestWithRetry('users.get', {
                user_ids: maxEntry.id,
                fields: 'counters,friend_status'
            })
            .then(userData => ({
                user: userData[0],
                maxEntry,
                source: friendSources.get(maxEntry.id)
            }));
        })
        .then(({ user, maxEntry, source }) => {
            resultBox.innerHTML = `
                <div class="text-success">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞:</div>
                <div class="user-item highlight">
                    <div class="id-badge bg-success">${maxEntry.id}</div>
                    <div>
                        ${user.first_name} ${user.last_name}<br>
                        <small class="text-muted">–î—Ä—É–∑–µ–π: ${user.counters?.friends || maxEntry.count}</small>
                    </div>
                </div>

                <div class="mt-3">–ù–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑:</div>
                <div class="user-item">
                    <div class="id-badge">${source.throughFriend.id}</div>
                    <div>
                        ${source.throughFriend.first_name} ${source.throughFriend.last_name}<br>
                        <a href="https://vk.com/${source.throughFriend.domain}" 
                        target="_blank" 
                        class="link-success small">
                        –ü—Ä–æ—Ñ–∏–ª—å –¥—Ä—É–≥–∞
                        </a>
                    </div>
                </div>

                <div class="mt-3 text-muted small">
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞:<br>
                    ‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥—Ä—É–∑–µ–π: ${limit}<br>
                    ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: ${candidates.length}<br>
                    ‚Ä¢ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${((Date.now() - startTime)/1000).toFixed(2)} —Å–µ–∫
                </div>
            `;
        })
        .catch(error => {
            resultBox.innerHTML = `
                <div class="text-danger">
                    –û—à–∏–±–∫–∞: ${error?.error_msg || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                </div>
            `;
        });
    }


        // –ó–∞–¥–∞–Ω–∏–µ 5
        function task5() {
        const resultBox = document.getElementById('task5-result');
        resultBox.style.display = 'block';
        resultBox.innerHTML = '<div class="text-muted">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤–æ—Å—Ç–Ω—É—é –ª–µ–Ω—Ç—É...</div>';

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π
        function vkRequestWithRetry(method, params, retries = 2) {
            return new Promise((resolve, reject) => {
                const attempt = (retryCount) => {
                    vkRequest(method, params)
                        .then(resolve)
                        .catch(error => {
                            if (error.error_code === 6 && retryCount > 0) {
                                setTimeout(() => attempt(retryCount - 1), 1000 * (3 - retryCount));
                            } else {
                                reject(error);
                            }
                        });
                };
                attempt(retries);
            });
        }

        let lastPost;
        let authorInfo;
        let postDate;
        let people = [];

        vkRequestWithRetry('newsfeed.get', {
            count: 1,
            filters: 'post'
        })
        .then(newsfeed => {
            if (!newsfeed.items.length) {
                resultBox.innerHTML = '<div class="text-warning">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –≤ –ª–µ–Ω—Ç–µ</div>';
                return Promise.reject('No posts');
            }

            lastPost = newsfeed.items[0];
            const authorId = lastPost.source_id;
            const isGroup = authorId < 0;
            postDate = new Date(lastPost.date * 1000).toLocaleString();

            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ
            return isGroup 
                ? vkRequestWithRetry('groups.getById', {
                    group_ids: Math.abs(authorId)
                })
                : vkRequestWithRetry('users.get', {
                    user_ids: authorId,
                    name_case: 'nom'
                });
        })
        .then(authorData => {
            const authorId = lastPost.source_id;
            const isGroup = authorId < 0;
            
            if (isGroup) {
                authorInfo = `–ì—Ä—É–ø–ø–∞: ${authorData[0].name} (ID: ${authorId})`;
                return vkRequestWithRetry('groups.getMembers', {
                    group_id: Math.abs(authorId),
                    count: 10,
                    fields: 'name'
                });
            } else {
                authorInfo = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${authorData[0].first_name} ${authorData[0].last_name} (ID: ${authorId})`;
                return vkRequestWithRetry('friends.get', {
                    user_id: authorId,
                    count: 10,
                    fields: 'name'
                });
            }
        })
        .then(relatedData => {
            people = relatedData.items || [];
            const namesHTML = people.map(person => `
                <div class="user-item">
                    <div class="id-badge small">${person.id}</div>
                    ${person.first_name} ${person.last_name}
                </div>
            `).join('');

            resultBox.innerHTML = `
                <div class="text-success mb-2">
                    ${authorInfo}<br>
                    <small>–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω: ${postDate}</small>
                </div>
                <div class="mt-3">–°–≤—è–∑–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</div>
                ${namesHTML || '<div class="text-warning">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
            `;
        })
        .catch(error => {
            const errorMsg = error.error_code === 15 ? "–ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞ –∑–∞–∫—Ä—ã—Ç" 
                : error.error_code === 6 ? "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤" 
                : error.error_msg || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                
            resultBox.innerHTML = `
                <div class="text-danger">
                    –û—à–∏–±–∫–∞: ${errorMsg}
                </div>
            `;
        });
    }
    </script>
</body>
</html>